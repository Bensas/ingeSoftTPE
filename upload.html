<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>TuviTicket</title>

    <link rel="shortcut icon" href="/img/favicon/favicon.ico" />
    <link
      rel="icon"
      sizes="16x16 32x32 64x64"
      href="/img/favicon/favicon.ico"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="196x196"
      href="/img/favicon/favicon-192.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="160x160"
      href="/img/favicon/favicon-160.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="96x96"
      href="/img/favicon/favicon-96.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="64x64"
      href="/img/favicon/favicon-64.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/img/favicon/favicon-32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/img/favicon/favicon-16.png"
    />
    <link rel="apple-touch-icon" href="/img/favicon/favicon-57.png" />
    <link
      rel="apple-touch-icon"
      sizes="114x114"
      href="/img/favicon/favicon-114.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="72x72"
      href="/img/favicon/favicon-72.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="144x144"
      href="/img/favicon/favicon-144.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="60x60"
      href="/img/favicon/favicon-60.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="120x120"
      href="/img/favicon/favicon-120.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="76x76"
      href="/img/favicon/favicon-76.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="152x152"
      href="/img/favicon/favicon-152.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/img/favicon/favicon-180.png"
    />
    <meta name="msapplication-TileColor" content="#FFFFFF" />
    <meta
      name="msapplication-TileImage"
      content="/img/favicon/favicon-144.png"
    />
    <meta
      name="msapplication-config"
      content="/img/favicon/browserconfig.xml"
    />

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet" />
    <!-- Material Design Bootstrap -->
    <link href="css/mdb.min.css" rel="stylesheet" />
    <!-- Your custom styles (optional) -->
    <link href="css/style.min.css" rel="stylesheet" />

    <link href="css/material-select.css" rel="stylesheet" />
    <style type="text/css">
      html,
      body,
      header,
      .carousel {
        height: 300px;
      }

      @media (min-width: 800px) and (max-width: 850px) {
        .navbar:not(.top-nav-collapse) {
          background: #1c2331 !important;
        }
      }

      .video-fluid {
        width: 100%;
        height: 100%;
      }

      .hiddenFileInput {
        width: 0px;
        height: 0px;
        overflow: hidden;
      }

      .img-thumbnail.favorite {
        background-color: rgba(255, 215, 0, 0.7) !important;
      }
    </style>
  </head>

  <body>
    <button
      class="btn btn-md btn-outline-mdb-color m-0 px-3 py-2 z-depth-0 waves-effect"
      onclick="$('#imageInput').trigger('click');"
    >
      <i class="fa fa-plus" aria-hidden="true"></i>&nbsp;Añadir archivo
    </button>

    <button
      class="btn btn-md btn-outline-mdb-color m-0 px-3 py-2 z-depth-0 waves-effect"
      onclick="upload();"
    >
      <i class="fa fa-plus" aria-hidden="true"></i>&nbsp;YAY
    </button>
    <div class="d-flex mb-3 justify-content-center" id="imageList">
      <span class="hiddenFileInput">
        <input type="file" id="imageInput" />
      </span>
    </div>
  </body>

  <!-- SCRIPTS -->
  <!-- JQuery -->
  <script type="text/javascript" src="js/jquery-3.3.1.min.js"></script>
  <!-- Bootstrap tooltips -->
  <script type="text/javascript" src="js/popper.min.js"></script>
  <!-- Bootstrap core JavaScript -->
  <script type="text/javascript" src="js/bootstrap.min.js"></script>
  <!-- MDB core JavaScript -->
  <script type="text/javascript" src="js/mdb.min.js"></script>
  <!-- Initializations -->
  <script type="text/javascript">
    // Animations initialization
    new WOW().init();
  </script>

  <script>
    var fileList = [];

    function createPreview(data, fileType, listItem) {
      var isCover = true; //TODO TU YA SABES :D

      var html =
        "<div class='view overlay img-thumbnail mb-3 image-canvas' style='height: 150px; width: 200px;'>";
      if (fileType == "image")
        html +=
          "<img src='" + data + "' alt='zoom' height='100%' width='100%'/>";
      else if (fileType == "video")
        html +=
          "<video class='video-fluid' autoplay loop muted><source src='" +
          data +
          "' type='video/mp4'/></video>";

      html +=
        "<div class='mask text-center align-middle waves-effect waves-light rgba-red-light white-text'><a class='btn btn-danger btn-sm canvas-delete'><i class='fa fa-trash' aria-hidden='true'></i>&nbsp;Borrar</a>";

      if (isCover)
        html +=
          "<a class='btn btn-yellow btn-sm'><i class='fa fa-star' aria-hidden='true'></i>&nbsp;Es portada</a>";
      else
        html +=
          "<a class='btn btn-outline-warning waves-effect btn-sm'><i class='fa fa-star-o' aria-hidden='true'></i>&nbsp;Elegir portada</a>";

      html += "</div></div>";

      var $preview = $(html);
      $preview.data("listItem", listItem);
      fileList.push(listItem);

      $("#imageList").append($preview);
    }

    function getExtension(filename) {
      return filename.split(".").pop();
    }

    function isImage(filename) {
      var ext = getExtension(filename);
      switch (ext.toLowerCase()) {
        case "jpg":
        case "jepg":
        case "png":
          return true;
      }
      return false;
    }

    function isVideo(filename) {
      var ext = getExtension(filename);
      switch (ext.toLowerCase()) {
        case "mp4":
          return true;
      }
      return false;
    }

    $("#imageInput").change(function() {
      if (this.files && this.files[0]) {
        var fileName = $(this).val();
        var fileType;

        if (isImage(fileName)) fileType = "image";
        else if (isVideo(fileName)) fileType = "video";
        else {
          alert("Tipo de archivo no soportado");
          return;
        }

        var listItem = {
          file: this.files[0],
          saved: false,
          deleted: false,
          serverName: null
        };

        //fileList.push(this.files[0]);

        var reader = new FileReader();

        reader.onload = function(e) {
          createPreview(e.target.result, fileType, listItem);
        };

        reader.readAsDataURL(this.files[0]);
      }
    });

    $("#imageList").on("click", ".canvas-delete", function() {
      var val = confirm(
        "¿Está seguro de que desea eliminar este archivo multimedia?"
      );
      if (val) {
        let listItem = $(this)
          .parent()
          .parent()
          .data("listItem");
        if (!listItem.saved) {
          let arrIndex = fileList.indexOf(listItem);
          fileList.splice(arrIndex, 1);
        } else {
          listItem.deleted = true;
        }
        $(this)
          .closest(".image-canvas")
          .remove();
      }
    });

    function upload() {
      $.ajax({
        url: "/scripts/event/postmedia.php",
        type: "POST",
        contentType: false,
        processData: false,
        data: (function() {
          var data = new FormData();
          for (let i = 0; i < fileList.length; i++)
            if (!fileList[i].saved) data.append("file[]", fileList[i].file);
            else if (fileList[i].deleted) {
              data.append("deleteList[]", fileList[i].serverName);
            }

          data.append("eventId", 1);
          return data;
        })(),
        success: function(result) {
          alert(result);
        },
        error: function(xhr, result, errorThrown) {
          alert("Request failed.");
        }
      });
    }

    $(function() {
      loadMedia();
    });

    var eventId = 1;

    function loadMedia() {
      $.get("/scripts/event/getmedia.php", { eventId: eventId }, function(
        data
      ) {
        var resp = JSON.parse(data);

        var path = "/img/events/" + eventId + "/";

        for (let i = 0; i < resp.images.length; i++) {
          let listItem = {
            file: null,
            saved: true,
            deleted: false,
            serverName: resp.images[i]
          };

          createPreview(path + resp.images[i], "image", listItem);
        }

        for (let i = 0; i < resp.videos.length; i++) {
          let listItem = {
            file: null,
            saved: true,
            deleted: false,
            serverName: resp.videos[i]
          };

          createPreview(path + resp.videos[i], "video", listItem);
        }
      });
    }
  </script>
</html>
